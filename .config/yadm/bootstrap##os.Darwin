#!/bin/bash
set -euo pipefail

# prompt for system password
sudo -v

# install or update aws cli
tmp_aws_dir=$(mktemp -d)
curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "${tmp_aws_dir}/AWSCLIV2.pkg"
sudo installer -pkg "${tmp_aws_dir}/AWSCLIV2.pkg" -target /
rm -rf "${tmp_aws_dir}"

# install homebrew if it's missing
if ! command -v brew >/dev/null 2>&1; then
    echo "Installing homebrew..."
    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

# install homebrew packages
if [ -f "$HOME/.Brewfile" ]; then
    echo "Updating homebrew bundle..."
    brew bundle --global
    brew bundle cleanup --global --force
fi

# install / update gh copilot cli
if gh extension list | grep -q 'gh-copilot'; then
    echo "gh copilot extension is installed. Updating..."
    gh extension upgrade gh-copilot
else
    echo "gh copilot is not installed. Installing..."
    gh extension install github/gh-copilot
fi

# install claude code
echo "Installing/updating Claude Code..."
curl -fsSL https://claude.ai/install.sh | bash

# in some cases after prettierd is updated, it needs to be restarted
prettierd restart

# install luacheck
echo "Installing luacheck..."
luarocks install luacheck

# turn off behavior to support accents when holding down key
# https://stackoverflow.com/a/39733008/3112403
echo "Turn off default Mac support for accents..."
defaults write -g ApplePressAndHoldEnabled -bool false

# install mise (if not already via brew)
if ! command -v mise >/dev/null 2>&1; then
    curl https://mise.run | sh
    export PATH="$HOME/.local/bin:$PATH"
fi
eval "$(mise activate bash --shims)"

mise install
mise prune --yes

# update completions
completions_dir="${HOME}/.config/zsh/completions"
mkdir -p "${completions_dir}"

echo "Installing/updating yadm completion..."
curl --location --silent https://raw.githubusercontent.com/TheLocehiliosan/yadm/master/completion/zsh/_yadm --output "${completions_dir}/_yadm"

command -v gh &>/dev/null && echo "Installing/updating gh completion..." && gh completion -s zsh >"${completions_dir}/_gh"
command -v docker &>/dev/null && echo "Installing/updating docker completion..." && docker completion zsh >"${completions_dir}/_docker"
command -v pip &>/dev/null && echo "Installing/updating pip completion..." && pip completion --zsh >"${completions_dir}/_pip"
command -v npm &>/dev/null && echo "Installing/updating npm completion..." && npm completion >"${completions_dir}/_npm"
command -v uv &>/dev/null && echo "Installing/updating uv completion..." && uv generate-shell-completion zsh >"${completions_dir}/_uv"
command -v uvx &>/dev/null && echo "Installing/updating uvx completion..." && uvx --generate-shell-completion zsh >"${completions_dir}/_uvx"
command -v poetry &>/dev/null && echo "Installing/updating poetry completion..." && poetry completions zsh >"${completions_dir}/_poetry"
command -v luarocks &>/dev/null && echo "Installing/updating luarocks completion..." && luarocks completion zsh >"${completions_dir}/_luarocks"
command -v mise &>/dev/null && echo "Installing/updating mise completion..." && mise completion zsh >"${completions_dir}/_mise"

# install tmux plugin manager
if [ ! -d "${HOME}/.tmux/plugins/tpm" ]; then
    echo "Installing tmux plugin manager..."
    mkdir -p "${HOME}/.tmux/plugins"
    git clone https://github.com/tmux-plugins/tpm "${HOME}/.tmux/plugins/tpm"
fi

# update tldr cache
echo "Updating the tldr cache..."
tldr --update
