# Set colors
# https://github.com/neovim/neovim/wiki/FAQ#colors-arent-displayed-correctly
set -g default-terminal "xterm-256color"

# Fix colors
# https://stackoverflow.com/a/60313682/3112403
set-option -ga terminal-overrides ",xterm-256color:Tc"

# Enable OSC 52 clipboard (tmux copy-mode emits OSC 52, inner apps forwarded)
set -s set-clipboard on

# Change prefix key to C-a, easier to type, same to "screen"
unbind C-b
set -g prefix C-a

# increase time allowed to repeat commands
set -g repeat-time 1500 # default 500

# Enable mouse support
set -g mouse on

# fix delay in exiting insert mode in neovim
# https://github.com/neovim/neovim/wiki/FAQ#esc-in-tmux-or-gnu-screen-is-delayed
set -sg escape-time 10

# Increase scrollback buffer size from 2000 to 50000 lines
set -g history-limit 50000

# Increase tmux messages display duration from 750ms to 4s
set -g display-time 4000

# Refresh 'status-left' and 'status-right' more often, from every 15s to 5s
set -g status-interval 5

# Focus events enabled for terminals that support them
set -g focus-events on

# Super useful when using "grouped sessions" and multi-monitor setup
setw -g aggressive-resize on

# Reload tmux config with Prefix + r
bind r source-file ~/.config/tmux/tmux.conf \; display "Reloaded tmux config"

# select next window
unbind n
bind -r C-] next-window

# select previous window
unbind p
bind -r C-[ previous-window

# vi style keybindings
setw -g mode-keys vi
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# bind "v" to enter visual mode, matching vim
bind -T copy-mode-vi v send -X begin-selection

# setup tmux vim-tmux-navigator
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?)(diff)?$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'

bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R

# Mapping for clear screen, since vim-tmux-navigator hijacks the default C-L
bind C-l send-keys 'C-l'

# rebind vertical split windows
unbind %
unbind v
unbind C-v
bind C-v split-window -h -c "#{pane_current_path}"

# rebind horizontal split windows
unbind '"'
unbind _
unbind C-_
bind C-_ split-window -v -c "#{pane_current_path}"

# rebind resizing panes to match neovim

# resize 5 rows up
unbind M-Up
bind-key -r -T prefix S-Up resize-pane -U 5

# resize 5 rows down
unbind M-Down
bind-key -r -T prefix S-Down resize-pane -D 5

# resize 5 rows right
unbind M-Right
bind-key -r -T prefix S-Right resize-pane -R 5

# resize 5 rows left
unbind M-Left
bind-key -r -T prefix S-Left resize-pane -L 5

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'catppuccin/tmux#v2.1.3'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'roosta/tmux-fuzzback'
set -g @plugin 'laktak/extrakto'
set -g @plugin 'omerxx/tmux-sessionx'

# tmux-yank: stay in copy mode after yanking (matches previous copy-pipe behavior)
set -g @yank_action 'copy-pipe'

# tmux-fuzzback: fuzzy search scrollback buffer (prefix + ?)
set -g @fuzzback-popup 1
set -g @fuzzback-popup-size '90%'

# extrakto: extract tokens from scrollback (prefix + tab)
set -g @extrakto_split_direction 'p'
set -g @extrakto_popup_size '90%'

# sessionx: session manager (prefix + O)
set -g @sessionx-bind 'o'
set -g @sessionx-zoxide-mode 'on'
set -g @sessionx-tmuxinator-mode 'on'
set -g @sessionx-preview-location 'right'
set -g @sessionx-preview-ratio '45%'
set -g @sessionx-filter-current 'false'
set -g @sessionx-git-branch 'on'
set -g @sessionx-tree-mode 'off'
set -g @sessionx-window-mode 'off'
set -g @sessionx-bind-kill-session 'alt-x'

# configure catppuccin theme (options must be set before TPM loads the plugin)
set -g @catppuccin_flavor 'mocha'
set -g @catppuccin_window_status_style 'rounded'
set -g status-position top

# enable pane titles
set-option -g pane-border-status top
set-option -g pane-border-format "#{pane_index}: #{pane_title}"

# auto renumber
set -g renumber-windows on

# Initialize TMUX plugin manager (must be after all @plugin declarations)
run '~/.config/tmux/plugins/tpm/tpm'

# status-left: empty (matches catppuccin default)
set -g status-left ""

# status-right: session + host + cpu (all hidden at narrow widths per catppuccin/tmux#415)
set -g status-right-length 100
set -g status-right ""
set -ag status-right '#{?#{e|>=:#{window_width},101},#{?,,'
set -agF status-right '#{E:@catppuccin_status_session}'
set -ag status-right '},}'
set -ag status-right '#{?#{e|>=:#{window_width},101},#{?,,'
set -agF status-right '#{E:@catppuccin_status_host}'
set -ag status-right '},}'
set -ag status-right '#{?#{e|>=:#{window_width},101},#{?,,'
set -agF status-right '#{E:@catppuccin_status_cpu}'
set -ag status-right '},}'

# Adapt prefix and status bar for mosh sessions (restore: tmux source ~/.config/tmux/tmux.conf)
set-hook -g client-attached 'run-shell "~/.config/tmux/refresh-status.sh"'
run-shell '~/.config/tmux/refresh-status.sh'

# === F12 toggle for nested tmux sessions ===

# Toggle OFF: disable prefix, dim outer status bar, pass all keys to inner session
bind -T root F12 \
    set prefix None \;\
    set key-table off \;\
    set -g status-position bottom \;\
    set -g pane-border-status off \;\
    set -g status-style "bg=#313244,fg=#6c7086" \;\
    set -g status-left "" \;\
    set -g status-right " #S ðŸ”’ " \;\
    set -g window-status-current-format " #W " \;\
    set -g window-status-format " #W " \;\
    if -F '#{pane_in_mode}' 'send-keys -X cancel'

# Toggle ON: restore Catppuccin theme by re-sourcing config
bind -T off F12 \
    set -u prefix \;\
    set -u key-table \;\
    source-file ~/.config/tmux/tmux.conf
